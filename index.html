<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è³¢å¾·å¿—å£«</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <link href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap" rel="stylesheet">
  
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(function(OneSignal) {
      OneSignal.init({
        appId: "2c0c1bb1-f413-474e-bc2d-45586547b981", 
        notifyButton: { enable: true },
        allowLocalhostAsSecureOrigin: true,
        
        // ğŸ”´ å¼·åŠ›ä¿®æ­£ï¼šæŒ‡å®šã€Œçµ•å°è·¯å¾‘ã€
        // å‘Šè¨´ OneSignal æª”æ¡ˆä¸€å®šåœ¨ /XIANDE/ è³‡æ–™å¤¾è£¡é¢
        path: "/XIANDE/", 

        // é¡å¤–ä¿éšªï¼šæŒ‡å®š Service Worker çš„ Scope
        serviceWorkerParam: { scope: "/XIANDE/" },

        promptOptions: {
          slidedown: {
            prompts: [{
              type: "push",
              autoPrompt: true,
              text: {
                actionMessage: "æ˜¯å¦å•Ÿç”¨ã€Œè³¢å¾·å¿—å£«ã€çš„ä¿®è¾¦é€šçŸ¥ï¼Ÿ",
                acceptButton: "å¥½ï¼Œé–‹å•Ÿé€šçŸ¥",
                cancelButton: "ç¨å¾Œå†èªª"
              }
            }]
          }
        }
      });
    });
  </script>

  <style>
    :root { --bg-color: #fdfbf7; --card-bg: #ffffff; --primary: #8bc34a; --accent: #ffb74d; --blue: #81d4fa; --red: #ff8a80; --text: #5d5d5d; --shadow: 0 4px 12px rgba(0,0,0,0.08); }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Varela Round', sans-serif; background: var(--bg-color); color: var(--text); margin: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;}
    .card { background: var(--card-bg); border-radius: 20px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 15px; width: 95%; max-width: 380px; border: 2px solid #fff; margin-left: auto; margin-right: auto;}
    .btn { width: 100%; padding: 12px; border-radius: 12px; border: none; font-weight: bold; color: #fff; cursor: pointer; margin-top: 5px; box-shadow: 0 3px 0 rgba(0,0,0,0.1); }
    .btn:active { transform: translateY(2px); box-shadow: none; }
    .btn-primary { background: var(--blue); } .btn-success { background: var(--primary); } .btn-warn { background: var(--accent); }
    .input-field { width: 100%; padding: 10px; margin: 5px 0; border: 2px solid #eee; border-radius: 10px; background: #fafafa; outline: none; font-family: inherit;}
    .view-section { display: none; width: 100%; animation: fadeIn 0.3s; }
    .view-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    #auth-screen { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background: linear-gradient(135deg, #e0f7fa, #fff3e0); width: 100%; position: absolute; top:0; left:0; height: 100%; z-index: 50; }
    #game-screen { display: none; height: 100%; flex-direction: column; width: 100%; }
    .viewport { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; width: 100%; }
    .top-nav { background: #fff; padding: 10px 15px; display: flex; flex-direction: column; box-shadow: 0 2px 5px rgba(0,0,0,0.05); z-index: 10;}
    .nav-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 5px;}
    .marquee-container { background: #d32f2f; color: #fff; font-size: 12px; white-space: nowrap; overflow: hidden; border-radius: 4px; padding: 2px 0; width: 100%; }
    .marquee-text { display: inline-block; padding-left: 100%; animation: scroll 15s linear infinite; }
    @keyframes scroll { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
    .bottom-nav { background: #fff; padding: 8px 0; display: flex; justify-content: space-around; border-top: 1px solid #eee; }
    .nav-btn { background: none; border: none; color: #ccc; font-size: 10px; flex: 1; text-align: center; }
    .nav-btn.active { color: var(--primary); transform: scale(1.1); transition: 0.2s;}
    .nav-icon { font-size: 20px; display: block; margin-bottom: 2px; }
    .orchard-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; width: 100%; padding-bottom: 20px;}
    .tree-container { text-align: center; margin-bottom: 10px; cursor: pointer; transition: transform 0.1s; position: relative;}
    .tree-container:active { transform: scale(0.95); }
    .tree-canopy { background: #66bb6a; border-radius: 50% 50% 40% 40%; margin: 0 auto; padding: 5px; display: flex; flex-wrap: wrap; justify-content: center; align-items: center; box-shadow: inset -5px -5px 10px rgba(0,0,0,0.1); position: relative; transition: width 0.3s, height 0.3s; }
    .tree-trunk { background: #8d6e63; margin: -2px auto 0 auto; border-radius: 0 0 5px 5px;}
    .tree-scale-s .tree-canopy { width: 100px; min-height: 80px; } .tree-scale-s .tree-trunk { width: 15px; height: 20px; }
    .tree-scale-m .tree-canopy { width: 130px; min-height: 100px; } .tree-scale-m .tree-trunk { width: 20px; height: 30px; }
    .tree-scale-l .tree-canopy { width: 160px; min-height: 120px; } .tree-scale-l .tree-trunk { width: 25px; height: 40px; }
    .tree-label { background: #fff; border: 1px solid #eee; padding: 4px 8px; border-radius: 8px; font-size: 12px; margin-top: 5px; display: inline-block; font-weight: bold; color: #333; box-shadow: 0 2px 5px rgba(0,0,0,0.05); line-height: 1.4; min-width: 90px; }
    .tree-stats { font-size: 10px; color: #666; display: flex; justify-content: center; gap: 5px; margin-top: 2px;}
    .fruit { width: 12px; height: 12px; border-radius: 50%; margin: 2px; box-shadow: 1px 1px 2px rgba(0,0,0,0.2); flex-shrink: 0;}
    .fruit.red { background: var(--red); } .fruit.gold { background: #ffd700; } .fruit.blue { background: #29b6f6; } 
    .calendar-ctrl { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .calendar-ctrl button { background: none; border: 1px solid #ddd; border-radius: 5px; padding: 2px 10px; cursor: pointer; color: #555; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; width: 100%; margin-top: 10px; }
    .cal-day { aspect-ratio: 1; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; background: #eee; color: #aaa; position: relative; overflow: hidden; }
    .cal-fill-1 { background: #c8e6c9; color: #2e7d32; } .cal-fill-2 { background: #81c784; color: #1b5e20; } .cal-fill-3 { background: #4caf50; color: #fff; font-weight:bold; }
    .profile-stats { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; font-size: 12px; line-height: 1.8; color: #555; }
    .profile-logs { margin-top: 15px; border-top: 1px dashed #eee; padding-top: 10px; font-size: 12px; }
    .profile-logs h5 { margin: 0 0 10px 0; color: #666; }
    .filter-group { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; }
    .filter-label { padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 20px; font-size: 12px; cursor: pointer; color: #666; transition: all 0.2s; user-select: none; display: flex; align-items: center; }
    .filter-label input { display: none; }
    .filter-label.checked { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .admin-report-box { background:#e3f2fd; padding:15px; border-radius:10px; margin-bottom:15px; font-size:13px; color:#0d47a1; }
    .admin-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:12px; align-items:center;}
    .admin-stat-badges span { padding:2px 5px; border-radius:4px; font-size:10px; margin-left:3px; color:#fff;}
    #modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:none; justify-content:center; align-items:center; }
    .modal-box { background:#fff; padding:20px; border-radius:15px; width:85%; max-width:320px; max-height:80%; overflow-y:auto; position:relative; }
    .modal-close { position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer; color:#aaa; }
    .member-row { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #eee; font-size:12px; }
    .log-item { padding: 10px; border-bottom: 1px solid #f0f0f0; display: flex; align-items: flex-start; text-align: left;}
    .log-time { font-size: 10px; color: #999; width: 60px; flex-shrink: 0; margin-top: 2px;}
    .log-content { font-size: 13px; color: #444; flex: 1;}
    .log-tag { font-size: 10px; padding: 2px 4px; border-radius: 4px; background: #eee; margin-right: 5px; color: #666;}
    .achieve-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; font-size: 14px;}
    .achieve-input { width: 60px; text-align: center; border: 2px solid #eee; border-radius: 8px; padding: 5px; font-weight: bold; color: var(--primary);}
    #loading { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:3000; display:none; justify-content:center; align-items:center; flex-direction:column;}
    .spinner { width: 30px; height: 30px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    #toast-container { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; z-index: 4000; pointer-events: none; }
    .toast { background: #fff; border-left: 5px solid var(--accent); box-shadow: 0 4px 15px rgba(0,0,0,0.15); border-radius: 8px; padding: 15px; margin-bottom: 10px; display: flex; align-items: center; animation: slideDown 0.5s ease-out, fadeOut 0.5s ease-in 4.5s forwards; pointer-events: auto; }
    @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    
    #ios-install-overlay { 
      position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; 
      box-shadow: 0 -5px 20px rgba(0,0,0,0.2); padding: 20px; z-index: 5000;
      border-radius: 20px 20px 0 0; text-align: center; display: none;
      animation: slideUp 0.5s ease-out;
    }
    @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    .ios-arrow { font-size: 30px; animation: bounce 1.5s infinite; display:block; margin-bottom: 10px;}
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(10px); } }
    
    #install-btn { display: none; background: #333; color: #fff; margin-top: 10px; }
  </style>
</head>
<body>

  <div id="loading"><div class="spinner"></div><div style="margin-top:10px; font-size:12px; color:#888;">é€£ç·šä¸­...</div></div>
  <div id="toast-container"></div>
  
  <div id="ios-install-overlay">
    <div style="font-weight:bold; font-size:16px; margin-bottom:10px; color:#333;">ğŸ“² å®‰è£ã€Œè³¢å¾·å¿—å£«ã€</div>
    <div style="font-size:13px; color:#666; line-height:1.6; margin-bottom:15px;">
      ç‚ºäº†ç²å¾—æœ€ä½³é«”é©—ï¼ˆå…¨è¢å¹•èˆ‡æ¨æ’­ï¼‰ï¼Œ<br>è«‹é»æ“Šä¸‹æ–¹ç€è¦½å™¨çš„ <span style="font-size:18px;">â‹</span> åˆ†äº«æŒ‰éˆ•ï¼Œ<br>ä¸¦é¸æ“‡ <b>ã€ŒåŠ å…¥ä¸»ç•«é¢ã€</b>ã€‚
    </div>
    <div class="ios-arrow">â¬‡</div>
    <button class="btn" style="background:#eee; color:#666;" onclick="document.getElementById('ios-install-overlay').style.display='none'">æˆ‘çŸ¥é“äº†</button>
  </div>

  <div id="modal-overlay" onclick="closeModal()">
    <div class="modal-box" onclick="event.stopPropagation()">
      <div class="modal-close" onclick="closeModal()">&times;</div>
      <h3 id="modal-title" style="margin-top:0; color:var(--primary);">å…¬å ‚åå–®</h3>
      <div id="modal-content">Loading...</div>
    </div>
  </div>

  <div id="auth-screen">
    <div style="font-size:26px; color:var(--text); margin-bottom:20px;">ğŸŒ³ è³¢å¾·å¿—å£«</div>
    <div class="card">
      <div style="display:flex; margin-bottom:15px; border-bottom:1px solid #eee;">
        <div onclick="toggleAuth('login')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:var(--primary); font-weight:bold;">ç™»å…¥</div>
        <div onclick="toggleAuth('register')" style="flex:1; text-align:center; padding:10px; cursor:pointer; color:#aaa;">è¨»å†Š</div>
      </div>
      <div id="f-login">
        <input id="l-u" class="input-field" placeholder="æ±‚é“å">
        <input id="l-p" type="password" class="input-field" placeholder="å¯†ç¢¼">
        <button class="btn btn-primary" onclick="doLogin()">é€²å…¥æœåœ’</button>
      </div>
      <div id="f-reg" style="display:none;">
        <input id="r-u" class="input-field" placeholder="è¨­å®šæ±‚é“å">
        <input id="r-p" type="password" class="input-field" placeholder="è¨­å®šå¯†ç¢¼">
        <select id="r-maj" class="input-field" onchange="updMinor()"><option>è¼‰å…¥ä¸­...</option></select>
        <select id="r-min" class="input-field"><option>è«‹å…ˆé¸åœ˜éšŠ</option></select>
        <button class="btn btn-success" onclick="doReg()">åŠ å…¥å¿—å£«</button>
      </div>
      <button id="install-btn" class="btn" onclick="installApp()">ğŸ“² å®‰è£ App åˆ°æ¡Œé¢</button>
    </div>
  </div>

  <div id="game-screen">
    <div class="top-nav">
      <div class="nav-header">
         <span style="font-weight:bold; color:var(--primary); font-size:16px;">è³¢å¾·å¿—å£«</span>
         <span id="ui-team" style="font-size:12px; color:#999;">--</span>
      </div>
      <div class="marquee-container">
         <div id="marquee-text" class="marquee-text">æ­¡è¿å›åˆ°è³¢å¾·å¿—å£«ä¿®è¾¦ç³»çµ±ï¼</div>
      </div>
    </div>

    <div class="viewport">
      <div id="v-home" class="view-section active">
        <div class="card">
           <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
             <span>ğŸ“– è®€æ›¸è¨ˆæ™‚</span>
             <span id="timer-display" style="font-size:20px; font-weight:bold; color:#ccc;">00:00</span>
           </div>
           <button id="btn-timer" class="btn btn-primary" onclick="toggleTimer()">é–‹å§‹è¨ˆæ™‚</button>
        </div>
        <div class="card" onclick="toggleSport()" style="display:flex; align-items:center; cursor:pointer;">
           <div id="ck-sport" style="width:24px; height:24px; border-radius:50%; border:2px solid #ddd; margin-right:15px; display:flex; justify-content:center; align-items:center; color:#fff;">âœ“</div>
           <span>ğŸƒ æ¯æ—¥é‹å‹• 30 åˆ†é˜</span>
        </div>
        <div class="card">
          <h3 style="margin-top:0; font-size:16px; color:var(--accent);">ğŸŒ± ä»Šæ—¥è€•è€˜æˆæœ</h3>
          <div class="achieve-row"><span>ğŸ—£ï¸ ä»Šæ—¥é–‹å£</span><div><input type="number" id="inp-spoke" class="achieve-input" value="0"> çœ¾</div></div>
          <div class="achieve-row"><span>ğŸ¤ ä»Šæ—¥æ¸¡çœ¾</span><div><input type="number" id="inp-conv" class="achieve-input" value="0" style="color:var(--accent); border-color:var(--accent);"> çœ¾</div></div>
          <div class="achieve-row"><span>ğŸ« æˆåŠŸå…¥ç­</span><div><input type="number" id="inp-class" class="achieve-input" value="0" style="color:var(--blue); border-color:var(--blue);"> çœ¾</div></div>
          <button class="btn btn-success" onclick="saveAchievements()">âœ… ç¢ºèªç´€éŒ„</button>
        </div>
      </div>

      <div id="v-orchard" class="view-section" style="text-align:center;">
        <button class="btn btn-primary" style="margin-bottom:20px; font-size:12px; padding:8px; width:auto;" onclick="loadOrchard()">ğŸ”„ æ›´æ–°æœåœ’ç‹€æ…‹</button>
        <div id="orchard-container" class="orchard-grid"></div>
      </div>

      <div id="v-logs" class="view-section">
        <div style="text-align:center; margin-bottom:10px;">
           <button class="btn btn-primary" style="padding:8px; font-size:12px; width:auto;" onclick="loadGlobalLogs()">ğŸ”„ æ›´æ–°å‹•æ…‹</button>
        </div>
        <div id="log-container" class="card" style="padding:0; overflow:hidden; width:100%;"></div>
      </div>

      <div id="v-profile" class="view-section">
        <div class="card" style="text-align:center;">
           <div style="font-size:40px;">ğŸ§‘â€ğŸŒ¾</div>
           <h3 id="p-job">ä¿®é“å¿—å£«</h3>
           <button class="btn btn-warn" onclick="logout()" style="width:100px; font-size:12px;">ç™»å‡º</button>
        </div>
        
        <div class="card">
           <div class="calendar-ctrl">
             <button onclick="changeMonth(-1)">&lt;</button>
             <span id="cal-title" style="font-weight:bold;">2025-01</span>
             <button onclick="changeMonth(1)">&gt;</button>
           </div>
           <div id="calendar-area" class="calendar-grid">Loading...</div>
           <div id="profile-stats" class="profile-stats"></div>
           <div class="profile-logs"><h5>ğŸ“… æœ¬æœˆé€ç­†æ˜ç´°</h5><div id="profile-log-list"></div></div>
        </div>
      </div>

      <div id="v-admin" class="view-section">
         <div class="card">
           <h3>ğŸ“Š ä¸»é ˜ç­å„€è¡¨æ¿</h3>
           
           <div style="margin-bottom:15px; display:flex; gap:10px; align-items:center;">
             <select id="adm-mode" class="input-field" onchange="toggleAdmDateInput()" style="flex:1;">
               <option value="all">å…¨éƒ¨æ­·å²</option>
               <option value="date">æŒ‡å®šæ—¥æœŸ</option>
               <option value="month">æŒ‡å®šæœˆä»½</option>
             </select>
             <div id="adm-date-box" style="flex:1; display:none;"><input type="date" id="adm-date" class="input-field"></div>
             <div id="adm-month-box" style="flex:1; display:none;"><input type="month" id="adm-month" class="input-field"></div>
           </div>

           <div style="display:flex; gap:5px; margin-bottom:10px;">
             <select id="adm-maj" class="input-field" onchange="admUpdMin()"><option value="å…¨éƒ¨">å…¨éƒ¨åœ˜éšŠ</option></select>
             <select id="adm-min" class="input-field"><option value="å…¨éƒ¨">å…¨éƒ¨å…¬å ‚</option></select>
           </div>
           
           <div class="filter-group">
             <label class="filter-label"><input type="checkbox" id="f-sport">ğŸƒ é‹å‹•</label>
             <label class="filter-label"><input type="checkbox" id="f-read">ğŸ“– è®€æ›¸</label>
             <label class="filter-label"><input type="checkbox" id="f-spoke">ğŸ—£ï¸ é–‹å£</label>
             <label class="filter-label"><input type="checkbox" id="f-conv">ğŸ¤ æ¸¡çœ¾</label>
             <label class="filter-label"><input type="checkbox" id="f-class">ğŸ« å…¥ç­</label>
           </div>

           <button class="btn btn-primary" onclick="runAdminQuery()">ğŸ” æŸ¥è©¢å ±è¡¨</button>
           
           <div id="admin-report" class="admin-report-box" style="display:none; margin-top:15px;"></div>
           <div id="admin-list" style="margin-top:10px;"></div>
           
           <hr style="border:0; border-top:1px dashed #eee; margin:15px 0;">
           <h4 style="margin:0 0 10px 0;">ğŸ“¢ å…¨å“¡æ¨æ’­ (OneSignal)</h4>
           <textarea id="broadcast-msg" class="input-field" rows="3" placeholder="è«‹è¼¸å…¥è¨Šæ¯..."></textarea>
           <div style="margin-top:5px; font-size:12px; color:#666;">
             <label>é ç´„ (é¸å¡«)ï¼š</label>
             <input type="datetime-local" id="broadcast-time" class="input-field">
           </div>
           <button class="btn btn-warn" onclick="sendBroadcast()" style="margin-top:10px;">ğŸš€ ç™¼é€é€šçŸ¥</button>
         </div>
      </div>

    </div>

    <div class="bottom-nav">
      <button class="nav-btn active" onclick="nav('home')" id="n-home"><span class="nav-icon">ğŸ“</span>ä¿®ç…‰</button>
      <button class="nav-btn" onclick="nav('orchard'); loadOrchard()" id="n-orchard"><span class="nav-icon">ğŸ</span>æœåœ’</button>
      <button class="nav-btn" onclick="nav('logs'); loadGlobalLogs()" id="n-logs"><span class="nav-icon">ğŸ“œ</span>ç™½é™½æ­·ç¨‹</button>
      <button class="nav-btn" onclick="nav('profile'); loadCalendar()" id="n-profile"><span class="nav-icon">ğŸ‘¤</span>æˆ‘çš„æ­·ç¨‹</button>
      <button class="nav-btn" onclick="nav('admin'); loadAdminFilters()" id="n-admin" style="display:none;"><span class="nav-icon">ğŸ›¡ï¸</span>ä¸»é ˜ç­</button>
    </div>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbxHe88NVoiJkAt2pvBnCYUk_xGul1FhXTAj0kyAXA9GEIddXB1AD8j4gtjhbDEASPSr/exec";

    var gUser=null, gPass=null, gData={}, menuConfig={};
    var timerInt=null, isTimer=false, lastLogTime=0;
    var curYear = new Date().getFullYear();
    var curMonth = new Date().getMonth() + 1;
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      document.getElementById('install-btn').style.display = 'block';
    });

    window.onload = function(){
        loading(true);
        var d = new Date();
        document.getElementById('adm-date').valueAsDate = d;
        var mStr = d.getFullYear() + "-" + ((d.getMonth()+1)<10?"0"+(d.getMonth()+1):(d.getMonth()+1));
        document.getElementById('adm-month').value = mStr;

        callApi('getConfig').then(cfg => {
            menuConfig = cfg.menu;
            if(cfg.announcement) document.getElementById('marquee-text').innerText = cfg.announcement;
            initMaj();
            var u = localStorage.getItem("xd_u"), p = localStorage.getItem("xd_p");
            if(u&&p){
               document.getElementById('l-u').value=u; document.getElementById('l-p').value=p;
               doLogin();
            } else { loading(false); }
        });
        
        setInterval(checkNewLogs, 10000);
        document.querySelectorAll('.filter-label input').forEach(inp => {
           inp.addEventListener('change', function(){
              if(this.checked) this.parentElement.classList.add('checked');
              else this.parentElement.classList.remove('checked');
           });
        });
        checkIOSInstall(); 
    }

    function installApp() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            document.getElementById('install-btn').style.display = 'none';
          }
          deferredPrompt = null;
        });
      } else {
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (!isIOS) {
           alert("è«‹ä½¿ç”¨ Chrome ç€è¦½å™¨é¸å–®ä¸­çš„ã€ŒåŠ å…¥ä¸»ç•«é¢ã€åŠŸèƒ½");
        }
      }
    }
    
    function checkIOSInstall() {
      var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      var isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
      if (isIOS && !isStandalone) {
        document.getElementById('ios-install-overlay').style.display = 'block';
      }
    }

    function callApi(action, params) {
        if(!params) params = {};
        params.action = action;
        return fetch(API_URL, {
            method: 'POST',
            body: JSON.stringify(params)
        }).then(res => res.json());
    }

    function loading(x){ document.getElementById('loading').style.display = x?'flex':'none'; }

    function toggleAdmDateInput() {
      var mode = document.getElementById('adm-mode').value;
      document.getElementById('adm-date-box').style.display = mode==='date' ? 'block' : 'none';
      document.getElementById('adm-month-box').style.display = mode==='month' ? 'block' : 'none';
    }

    function initMaj(){
      var s=document.getElementById('r-maj'); s.innerHTML="<option disabled selected>é¸æ“‡åœ˜éšŠ</option>";
      for(var k in menuConfig){ var o=document.createElement('option'); o.value=k; o.innerText=k; s.appendChild(o); }
    }
    function updMinor(){
      var m=document.getElementById('r-maj').value, s=document.getElementById('r-min'); s.innerHTML="";
      if(menuConfig[m]) menuConfig[m].forEach(function(x){ var o=document.createElement('option'); o.value=x; o.innerText=x; s.appendChild(o); });
    }
    function toggleAuth(t){
      document.getElementById('f-login').style.display=t=='login'?'block':'none';
      document.getElementById('f-reg').style.display=t=='register'?'block':'none';
    }
    function nav(t){
      ['home','orchard','logs','profile','admin'].forEach(x=>{
          if(document.getElementById('v-'+x)) document.getElementById('v-'+x).classList.remove('active');
          if(document.getElementById('n-'+x)) document.getElementById('n-'+x).classList.remove('active');
      });
      document.getElementById('v-'+t).classList.add('active');
      document.getElementById('n-'+t).classList.add('active');
    }

    function doReg(){
      var u=document.getElementById('r-u').value, p=document.getElementById('r-p').value, maj=document.getElementById('r-maj').value, min=document.getElementById('r-min').value;
      if(!u||!p||!maj||!min){ alert("è«‹å¡«å¯«å®Œæ•´"); return; }
      loading(true);
      callApi('register', {u:u, p:p, maj:maj, min:min}).then(r => {
        loading(false); alert(r.msg); if(r.success) toggleAuth('login');
      });
    }
    function doLogin(){
      var u=document.getElementById('l-u').value, p=document.getElementById('l-p').value;
      loading(true);
      callApi('login', {u:u, p:p}).then(r => {
        loading(false);
        if(r.success){
          gUser=u; gPass=p; gData=r.gameData;
          localStorage.setItem("xd_u",u); localStorage.setItem("xd_p",p);
          lastLogTime = new Date().getTime();
          if(gData.teamMajor === "ä¸»é ˜ç­") { document.getElementById('n-admin').style.display = 'block'; }
          enterGame();
        } else { alert(r.msg); }
      });
    }
    function enterGame(){
      document.getElementById('auth-screen').style.display='none';
      document.getElementById('game-screen').style.display='flex';
      renderUI();
    }
    function renderUI(){
      document.getElementById('ui-team').innerText = gData.teamFull;
      document.getElementById('p-job').innerText = gData.job;
      document.getElementById('inp-spoke').value = gData.spoke_count || 0;
      document.getElementById('inp-conv').value = gData.convert_count || 0;
      document.getElementById('inp-class').value = gData.class_count || 0;
      var ck = document.getElementById('ck-sport');
      if(gData.task_sport_done){ ck.style.background='var(--primary)'; ck.style.borderColor='var(--primary)'; }
      else { ck.style.background='transparent'; ck.style.borderColor='#ddd'; }
      updTimer(gData.task_read_time||0);
    }
    function logout(){ if(confirm("ç™»å‡º?")){ localStorage.removeItem("xd_p"); location.reload(); } }

    function toggleTimer(){
      var b = document.getElementById('btn-timer');
      if(isTimer){
        clearInterval(timerInt); isTimer=false; b.innerText="ç¹¼çºŒè¨ˆæ™‚"; b.className="btn btn-primary";
        saveData({action:"è®€æ›¸", detail:"ç´¯è¨ˆ "+Math.floor(gData.task_read_time/60)+" åˆ†é˜"});
      } else {
        timerInt = setInterval(function(){ gData.task_read_time=(gData.task_read_time||0)+1; updTimer(gData.task_read_time); }, 1000);
        isTimer=true; b.innerText="æš«åœè¨ˆæ™‚"; b.className="btn btn-warn";
      }
    }
    function updTimer(s){
      var m=Math.floor(s/60), sec=s%60;
      document.getElementById('timer-display').innerText = (m<10?"0"+m:m)+":"+(sec<10?"0"+sec:sec);
    }
    function toggleSport(){
      if(gData.task_sport_done) return; 
      gData.task_sport_done = true; renderUI();
      saveData({action:"é‹å‹•", detail:"å®Œæˆä»Šæ—¥30åˆ†é˜é‹å‹•ï¼"});
    }
    function saveAchievements(){
      gData.spoke_count = document.getElementById('inp-spoke').value;
      gData.convert_count = document.getElementById('inp-conv').value;
      gData.class_count = document.getElementById('inp-class').value;
      loading(true);
      var msg = `é–‹å£${gData.spoke_count}, æ¸¡çœ¾${gData.convert_count}, å…¥ç­${gData.class_count}`;
      callApi('saveGameData', {u:gUser, p:gPass, data:gData, log:{action:"å›å ±æˆæœ", detail: msg}}).then(r => {
        loading(false); showToast("ğŸ“œ ç´€éŒ„å·²åŒæ­¥ï¼");
      });
    }
    function saveData(logObj){ callApi('saveGameData', {u:gUser, p:gPass, data:gData, log:logObj}); }

    function loadOrchard(){
      document.getElementById('orchard-container').innerHTML = '<div style="color:#aaa;">æ­£åœ¨ç‚ºæœæ¨¹æ¾†æ°´...</div>';
      callApi('getOrchardData').then(data => {
        var html = "";
        for(var key in data){
          var hall = data[key];
          var fruits = "";
          var sp = Number(hall.spoke)||0;
          var cv = Number(hall.convert)||0;
          var cl = Number(hall.joinClass)||0;
          
          var redFruits = Math.floor(sp / 10);
          var totalPoints = redFruits + cv + cl;
          var treeClass = "tree-scale-s";
          if(totalPoints > 20) treeClass = "tree-scale-l";
          else if(totalPoints > 5) treeClass = "tree-scale-m";
          
          for(var i=0; i<redFruits && i<10; i++) fruits += '<div class="fruit red"></div>';
          for(var i=0; i<cv && i<10; i++) fruits += '<div class="fruit gold"></div>';
          for(var i=0; i<cl && i<10; i++) fruits += '<div class="fruit blue"></div>';
          if(totalPoints == 0) fruits = '<span style="font-size:10px; color:#fff;">ç¨®å­</span>';

          html += `
          <div class="tree-container ${treeClass}" onclick="openHallModal('${hall.name}')">
             <div class="tree-canopy">${fruits}</div>
             <div class="tree-trunk"></div>
             <div class="tree-label">
               <div>${hall.name}</div>
               <div class="tree-stats">
                 <span style="color:#e53935">â—${sp}</span>
                 <span style="color:#fbc02d">â—${cv}</span>
                 <span style="color:#039be5">â—${cl}</span>
               </div>
             </div>
          </div>`;
        }
        if(html == "") html = "<div>å°šç„¡æœæ¨¹</div>";
        document.getElementById('orchard-container').innerHTML = html;
      });
    }
    function openHallModal(hallName) {
      document.getElementById('modal-overlay').style.display = 'flex';
      document.getElementById('modal-title').innerText = hallName;
      document.getElementById('modal-content').innerHTML = "Loading...";
      callApi('getHallDetails', {hall:hallName}).then(res => {
        var h = "";
        if(res.list.length == 0) h = "<div>æš«ç„¡æˆå“¡æ•¸æ“š</div>";
        else {
          res.list.forEach(function(m){
            h += `<div class="member-row">
              <span style="font-weight:bold;">${m.name}</span>
              <span>
                 <span style="color:#e53935; margin-left:5px;">${m.s}</span>
                 <span style="color:#fbc02d; margin-left:5px;">${m.c}</span>
                 <span style="color:#039be5; margin-left:5px;">${m.cl}</span>
              </span>
            </div>`;
          });
        }
        document.getElementById('modal-content').innerHTML = h;
      });
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

    function changeMonth(delta) {
      curMonth += delta;
      if(curMonth > 12) { curMonth = 1; curYear++; }
      if(curMonth < 1) { curMonth = 12; curYear--; }
      loadCalendar();
    }

    function loadCalendar() {
      var mStr = curYear + "-" + (curMonth<10?"0"+curMonth:curMonth);
      document.getElementById('cal-title').innerText = mStr;
      document.getElementById('calendar-area').innerHTML = "Loading...";
      document.getElementById('profile-stats').innerHTML = "";
      document.getElementById('profile-log-list').innerHTML = "";

      callApi('getCalendarData', {u:gUser, year:curYear, month:curMonth}).then(res => {
        var daysInMonth = new Date(curYear, curMonth, 0).getDate();
        var html = "";
        for(var d=1; d<=daysInMonth; d++) {
           var dStr = mStr + "-" + (d<10?"0"+d:d);
           var dayData = res.cal[dStr];
           var cls = "cal-day";
           if(dayData) {
             var count = 0;
             if(dayData.read) count++;
             if(dayData.sport) count++;
             if(dayData.achieve) count++;
             if(count > 0) cls += " cal-fill-" + count;
           }
           html += `<div class="${cls}">${d}</div>`;
        }
        document.getElementById('calendar-area').innerHTML = html;

        var s = res.stats;
        var statHtml = `
          <b>ğŸ“Š ${mStr} æœˆå ±è¡¨</b><br>
          é‹å‹•å¤©æ•¸: ${s.sportDays} å¤© | è®€æ›¸å¤©æ•¸: ${s.readDays} å¤©<br>
          ç¸½é–‹å£: ${s.totalSpoke} | ç¸½æ¸¡çœ¾: ${s.totalConv} | ç¸½å…¥ç­: ${s.totalClass}
        `;
        document.getElementById('profile-stats').innerHTML = statHtml;
        
        var logHtml = "";
        if(res.logs.length == 0) logHtml = "<div style='color:#999;text-align:center;'>å°šç„¡ç´€éŒ„</div>";
        res.logs.forEach(function(l){
           logHtml += `<div class="log-item" style="font-size:11px;">
             <div style="width:70px;color:#888;">${l.time.substring(5)}</div>
             <div style="flex:1;"><b>${l.action}</b>: ${l.detail}</div>
           </div>`;
        });
        document.getElementById('profile-log-list').innerHTML = logHtml;
      });
    }

    function loadAdminFilters() {
      var maj = document.getElementById('adm-maj');
      maj.innerHTML = "<option value='å…¨éƒ¨'>å…¨éƒ¨åœ˜éšŠ</option>";
      for(var k in menuConfig) {
        var o = document.createElement('option'); o.value=k; o.innerText=k; maj.appendChild(o);
      }
    }
    function admUpdMin() {
      var maj = document.getElementById('adm-maj').value;
      var min = document.getElementById('adm-min');
      min.innerHTML = "<option value='å…¨éƒ¨'>å…¨éƒ¨å…¬å ‚</option>";
      if(menuConfig[maj]) {
        menuConfig[maj].forEach(x => {
          var o = document.createElement('option'); o.value=x; o.innerText=x; min.appendChild(o);
        });
      }
    }
    function runAdminQuery() {
      var filters = {
        major: document.getElementById('adm-maj').value,
        minor: document.getElementById('adm-min').value,
        hasSport: document.getElementById('f-sport').checked,
        hasRead: document.getElementById('f-read').checked,
        hasSpoke: document.getElementById('f-spoke').checked,
        hasConv: document.getElementById('f-conv').checked,
        hasClass: document.getElementById('f-class').checked
      };
      var mode = document.getElementById('adm-mode').value;
      var dateVal = "";
      if(mode === 'date') dateVal = document.getElementById('adm-date').value;
      if(mode === 'month') dateVal = document.getElementById('adm-month').value;
      
      loading(true);
      callApi('getAdminReport', {filters:filters, mode:mode, dateVal:dateVal}).then(res => {
        loading(false);
        var st = res.stats;
        var repHtml = `
          <div><b>[${mode === 'all' ? 'å…¨éƒ¨æ­·å²' : dateVal}]</b></div>
          <div>ç¯©é¸äººæ•¸: <b>${st.count}</b></div>
          <div>ç´¯è¨ˆé–‹å£: ${st.totalSpoke} | æ¸¡çœ¾: ${st.totalConv} | å…¥ç­: ${st.totalClass}</div>
          <div>é‹å‹•äººæ¬¡: ${st.totalSport}</div>
        `;
        document.getElementById('admin-report').innerHTML = repHtml;
        document.getElementById('admin-report').style.display = 'block';

        var listHtml = "";
        if(res.list.length == 0) listHtml = "<div style='text-align:center; color:#999;'>ç„¡ç¬¦åˆè³‡æ–™</div>";
        res.list.forEach(function(u){
           var badges = "";
           if(u.sportCount > 0) badges += `<span style='background:#8bc34a'>é‹${u.sportCount}</span>`;
           if(u.readCount > 0) badges += `<span style='background:#81d4fa'>è®€${u.readCount}</span>`;
           if(u.spoke > 0) badges += `<span style='background:#ff8a80'>é–‹${u.spoke}</span>`;
           if(u.conv > 0) badges += `<span style='background:#ffd54f'>æ¸¡${u.conv}</span>`;

           listHtml += `
           <div class="admin-row">
             <div style="flex:1">
               <div style="font-weight:bold;">${u.name}</div>
               <div style="font-size:10px; color:#999;">${u.minor}</div>
             </div>
             <div class="admin-stat-badges" style="text-align:right;">${badges}</div>
           </div>`;
        });
        document.getElementById('admin-list').innerHTML = listHtml;
      });
    }

    function sendBroadcast() {
      var msg = document.getElementById('broadcast-msg').value;
      if (!msg) { alert("è«‹è¼¸å…¥è¨Šæ¯å…§å®¹"); return; }
      var timeStr = document.getElementById('broadcast-time').value; // 2025-12-25T14:00
      
      if(confirm("ç¢ºå®šè¦ç™¼é€/æ’ç¨‹é€™å‰‡é€šçŸ¥çµ¦æ‰€æœ‰äººå—ï¼Ÿ")) {
        loading(true);
        callApi('broadcast', {msg: msg, time: timeStr}).then(res => {
          loading(false);
          if (res.success) {
            alert(res.msg);
            document.getElementById('broadcast-msg').value = "";
          } else {
            alert("ç™¼é€å¤±æ•—: " + res.msg);
          }
        });
      }
    }

    function loadGlobalLogs(){
      var c = document.getElementById('log-container'); c.innerHTML = '<div style="padding:20px; text-align:center;">è®€å–ä¸­...</div>';
      callApi('getGlobalLogs').then(res => {
        var h = "";
        if(res.list.length==0) h='<div style="padding:20px; text-align:center;">å°šç„¡ç´€éŒ„</div>';
        res.list.forEach(function(l){
          var color = "#eee";
          if(l.action.includes("é‹å‹•")) color="#e8f5e9"; 
          if(l.action.includes("è®€æ›¸")) color="#e3f2fd"; 
          if(l.action.includes("å›å ±")) color="#fff3e0"; 
          h += `<div class="log-item"><div class="log-time">${l.time}</div><div class="log-content"><span style="font-weight:bold; color:#555;">${l.user}</span> <span class="log-tag" style="background:${color}">${l.action}</span><span>${l.detail}</span><div style="font-size:9px; color:#bbb;">(${l.hall})</div></div></div>`;
        });
        c.innerHTML = h;
      });
    }

    function checkNewLogs() {
      if (!gUser) return;
      callApi('getLatestLog').then(log => {
        if(log && log.timestamp > lastLogTime) {
          lastLogTime = log.timestamp;
          var icon = "ğŸ””";
          if(log.action.includes("é‹å‹•")) icon = "ğŸƒ";
          if(log.action.includes("è®€æ›¸")) icon = "ğŸ“–";
          if(log.action.includes("å›å ±")) icon = "ğŸŒ±";
          showToast(`${log.user} ${log.action}`, icon);
        }
      });
    }

    function showToast(msg, icon="âœ¨") {
      var container = document.getElementById('toast-container');
      var el = document.createElement('div');
      el.className = 'toast';
      el.innerHTML = `<div class="toast-icon">${icon}</div><div class="toast-content"><div class="toast-title">æ–°å‹•æ…‹</div><div>${msg}</div></div>`;
      container.appendChild(el);
      setTimeout(function(){ if(el.parentNode) el.parentNode.removeChild(el); }, 5000); 
    }
  </script>
</body>
</html>
